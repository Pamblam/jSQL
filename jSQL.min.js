/**
 * jSQL.js
 * A Javascript Query Language Database Engine
 * @author Robert Parham
 * @website https://github.com/Pamblam/jSQL#jsql
 * @license http://www.apache.org/licenses/LICENSE-2.0
 */

window.jSQL=function(){"use strict";function jSQLDataTypeList(){this.list=[{type:"NUMERIC",aliases:["NUMBER","DECIMAL","FLOAT"],serialize:function(e,t){return!isNaN(parseFloat(e))&&isFinite(e)?parseFloat(e):0},unserialize:function(e,t){return!isNaN(parseFloat(e))&&isFinite(e)?parseFloat(e):0}},{type:"FUNCTION",serialize:function(e,t){return"function"!=typeof e&&(e=function(){}),"jSQLFunct-"+e.toString()},unserialize:function(value,args){var p=value.split("-");if("jSQLFunct"!==p.shift())throw"Corrupted function stored in data";p=value.split("-"),p.shift();var f=null;try{eval("f = "+p.join("-"))}catch(e){}if("function"==typeof f)return f;throw"Corrupted function stored in data"}},{type:"BOOLEAN",aliases:["BOOL"],serialize:function(e,t){return!!e},unserialize:function(e,t){return!!e}},{type:"INT",serialize:function(e,t){return!isNaN(parseInt(e))&&isFinite(e)?parseInt(e):0},unserialize:function(e,t){return!isNaN(parseInt(e))&&isFinite(e)?parseInt(e):0}},{type:"CHAR",aliases:["VARCHAR","LONGTEXT","MEDIUMTEXT"],serialize:function(e,t){return""+e},unserialize:function(e,t){return""+e}},{type:"DATE",serialize:function(e,t){return e instanceof Date?e.getTime():new Date(0).now()},unserialize:function(e,t){return new Date(e)}},{type:"AMBI",serialize:function(e,t){return e instanceof Date?e.getTime():"function"==typeof e?"jSQLFunct-"+e.toString():!isNaN(parseFloat(e))&&isFinite(e)?e:""+e},unserialize:function(value,args){if("string"==typeof value&&"jSQLFunct"===value.split("-")[0]){var p=value.split("-");p.shift();var f=null;try{eval("f = "+p.join("-"))}catch(e){}if("function"==typeof f)return f}return value}}],this.add=function(e){if("object"!=typeof e)throw"Invalid datatype definition";if(void 0===e.type)throw"DataType must have a `type` property.";if("function"!=typeof e.serialize)throw"DataType must have a `serialize` function.";if("function"!=typeof e.unserialize)throw"DataType must have an `unserialize` function.";this.list.push({type:e.type.toUpperCase(),aliases:Array.isArray(e.aliases)?e.aliases:[],serialize:e.serialize,unserialize:e.unserialize})},this.exists=function(e){e=e.toUpperCase();for(var t=this.list.length;t--;)if(this.list[t].type===e||void 0!==this.list[t].aliases&&this.list[t].aliases.indexOf(e)>-1)return!0;return!1},this.getByType=function(e){e=e.toUpperCase();for(var t=this.list.length;t--;)if(this.list[t].type===e||void 0!==this.list[t].aliases&&this.list[t].aliases.indexOf(e)>-1)return this.list[t];throw e+" is not a supported datatype"}}function jSQLTable(e,t,n,r){var a=this;a.name="",a.columns=[],a.data=[],a.colmap={},a.types=[],a.init=function(e,t,n,r){if(a.name=e,void 0===r&&(r=[]),!Array.isArray(r))throw"Invalid table types array";if(Array.isArray(t)&&void 0===n&&(n=t,t=[]),Array.isArray(t)&&!Array.isArray(t[0])&&"object"==typeof t[0]){var i=[];for(var e in t[0])t[0].hasOwnProperty(e)&&i.push(e);n=t,t=i}if(!Array.isArray(t))throw"Columns must be an array.";a.columns=t;for(var s=0;s<t.length;s++)a.types[s]=void 0===r[s]||void 0===r[s].type?{type:"ambi",args:[]}:r[s];for(var s=a.types.length;s--;){var o=a.types[s].type.toUpperCase();if(!jSQL.types.exists(o))throw o+" is not a supported data type";a.types[s].type=o}for(var s=0;s<t.length;s++)a.colmap[t[s]]=s;void 0!==n&&a.loadData(n)},a.renameColumn=function(e,t){if(void 0===e||"string"!=typeof t)throw"renameColumn expects and old column name and a new one, both must be strings.";if(a.columns.indexOf(e)<0)throw"The column "+e+" does not exist in this table.";a.columns.splice(a.columns.indexOf(e),1,t)},a.addColumn=function(e,t,n){(void 0===n||void 0===n.type)&&(n={type:"AMBI",args:[]}),n.type=n.type.toUpperCase(),void 0===t&&(t=null),"string"!=typeof e&&(e=function i(e){for(var t=0;t<a.columns.length;t++)if(a.columns[t]=="u"+e)return i(e+1);return"u"+e}(0)),a.columns.push(e);for(var r=a.data.length;r--;)a.data[r].push(t);if(a.colmap[e]=a.columns.length-1,!jSQL.types.exists(n.type))throw n.type+" is not a supported data type";a.types.push(n)},a.loadData=function(e){if(!Array.isArray(e))throw"Data must be an array.";var t=e.length;for(a.columns.length;t--;)a.insertRow(e[t])},a.insertRow=function(e){var t=[];if(Array.isArray(e)){for(;e.length>a.columns.length;)a.addColumn();for(;e.length<a.columns.length;)e.push(null);for(var n=0;n<e.length;n++)t.push(e[n]);for(;t.length<a.columns.length;)t.push(null)}else{if("object"!=typeof e)throw"Data not structured properly.";for(var n=0;n<a.columns.length;n++)void 0===e[a.columns[n]]&&(e[a.columns[n]]=null);for(var r in e)if(!e.hasOwnProperty(r))continue;if(function(e){for(;e--;)if(a.columns[e]==r)return 0;return 1}(a.columns.length))if(a.columns.indexOf("u0")>-1){a.renameColumn("u0",r);for(var i=1;a.columns.indexOf("u"+i)>-1;)a.renameColumn("u"+i,"u"+(i-1))}else a.addColumn(r);for(var n=0;n<a.columns.length;n++)t.push(e[a.columns[n]])}for(var i=t.length;i--;)t[i]=a.normalizeColumnStoreValue(a.columns[i],t[i]);a.data.push(t)},a.normalizeColumnStoreValue=function(e,t){var n=a.types[a.colmap[e]],r=jSQL.types.getByType(n.type.toUpperCase()).serialize(t,n.args);if(!isNaN(parseFloat(r))&&isFinite(r)||"string"==typeof r)return r;throw n.type.toUpperCase()+".serialize() must return a number or a string."},a.normalizeColumnFetchValue=function(e,t){var n=a.types[a.colmap[e]];return jSQL.types.getByType(n.type.toUpperCase()).unserialize(t,n.args)},a.init(e,t,n,r)}function jSQLQuery(e){var t=this;t.type=e.toUpperCase(),t.tablename=null,t.columns=[],t.data=[],t.INEFlag=!1,t.coltypes=[],t.table=null,t.newvals={},t.whereClause=new jSQLWhereClause(t),t.resultSet=[],t.init=function(){switch(t.type){case"CREATE":return(new jSQLCreateQuery).init.apply(t,arguments);case"UPDATE":return(new jSQLUpdateQuery).init.apply(t,arguments);case"SELECT":return(new jSQLSelectQuery).init.apply(t,arguments);case"INSERT":return(new jSQLInsertQuery).init.apply(t,arguments);case"DROP":return(new jSQLDropQuery).init.apply(t,arguments);case"DELETE":return(new jSQLDeleteQuery).init.apply(t,arguments)}},t.ifNotExists=function(){switch(t.type){case"CREATE":return(new jSQLCreateQuery).ifNotExists.apply(t,arguments);case"UPDATE":return(new jSQLUpdateQuery).ifNotExists.apply(t,arguments);case"SELECT":return(new jSQLSelectQuery).ifNotExists.apply(t,arguments);case"INSERT":return(new jSQLInsertQuery).ifNotExists.apply(t,arguments);case"DROP":return(new jSQLDropQuery).ifNotExists.apply(t,arguments);case"DELETE":return(new jSQLDeleteQuery).ifNotExists.apply(t,arguments)}},t.execute=function(){switch(t.type){case"CREATE":return(new jSQLCreateQuery).execute.apply(t,arguments);case"UPDATE":return(new jSQLUpdateQuery).execute.apply(t,arguments);case"SELECT":return(new jSQLSelectQuery).execute.apply(t,arguments);case"INSERT":return(new jSQLInsertQuery).execute.apply(t,arguments);case"DROP":return(new jSQLDropQuery).execute.apply(t,arguments);case"DELETE":return(new jSQLDeleteQuery).execute.apply(t,arguments)}},t.fetch=function(){switch(t.type){case"CREATE":return(new jSQLCreateQuery).fetch.apply(t,arguments);case"UPDATE":return(new jSQLUpdateQuery).fetch.apply(t,arguments);case"SELECT":return(new jSQLSelectQuery).fetch.apply(t,arguments);case"INSERT":return(new jSQLInsertQuery).fetch.apply(t,arguments);case"DROP":return(new jSQLDropQuery).fetch.apply(t,arguments);case"DELETE":return(new jSQLDeleteQuery).fetch.apply(t,arguments)}},t.fetchAll=function(){switch(t.type){case"CREATE":return(new jSQLCreateQuery).fetchAll.apply(t,arguments);case"UPDATE":return(new jSQLUpdateQuery).fetchAll.apply(t,arguments);case"SELECT":return(new jSQLSelectQuery).fetchAll.apply(t,arguments);case"INSERT":return(new jSQLInsertQuery).fetchAll.apply(t,arguments);case"DROP":return(new jSQLDropQuery).fetchAll.apply(t,arguments);case"DELETE":return(new jSQLDeleteQuery).fetchAll.apply(t,arguments)}},t.values=function(){switch(t.type){case"CREATE":return(new jSQLCreateQuery).values.apply(t,arguments);case"UPDATE":return(new jSQLUpdateQuery).values.apply(t,arguments);case"SELECT":return(new jSQLSelectQuery).values.apply(t,arguments);case"INSERT":return(new jSQLInsertQuery).values.apply(t,arguments);case"DROP":return(new jSQLDropQuery).values.apply(t,arguments);case"DELETE":return(new jSQLDeleteQuery).values.apply(t,arguments)}},t.set=function(){switch(t.type){case"CREATE":return(new jSQLCreateQuery).set.apply(t,arguments);case"UPDATE":return(new jSQLUpdateQuery).set.apply(t,arguments);case"SELECT":return(new jSQLSelectQuery).set.apply(t,arguments);case"INSERT":return(new jSQLInsertQuery).set.apply(t,arguments);case"DROP":return(new jSQLDropQuery).set.apply(t,arguments);case"DELETE":return(new jSQLDeleteQuery).set.apply(t,arguments)}},t.where=function(){switch(t.type){case"CREATE":return(new jSQLCreateQuery).where.apply(t,arguments);case"UPDATE":return(new jSQLUpdateQuery).where.apply(t,arguments);case"SELECT":return(new jSQLSelectQuery).where.apply(t,arguments);case"INSERT":return(new jSQLInsertQuery).where.apply(t,arguments);case"DROP":return(new jSQLDropQuery).where.apply(t,arguments);case"DELETE":return(new jSQLDeleteQuery).where.apply(t,arguments)}},t.from=function(){switch(t.type){case"CREATE":return(new jSQLCreateQuery).from.apply(t,arguments);case"UPDATE":return(new jSQLUpdateQuery).from.apply(t,arguments);case"SELECT":return(new jSQLSelectQuery).from.apply(t,arguments);case"INSERT":return(new jSQLInsertQuery).from.apply(t,arguments);case"DROP":return(new jSQLDropQuery).from.apply(t,arguments);case"DELETE":return(new jSQLDeleteQuery).from.apply(t,arguments)}}}function jSQLDeleteQuery(){this.init=function(e){if(void 0===jSQL.tables[e])throw"Table: "+e+" doesn't exist.";return this.table=this.table=jSQL.tables[e],this},this.execute=function(){for(var e=[],t=0;t<this.table.data.length&&!(this.whereClause.LIMIT>0&&e.length==this.whereClause.LIMIT);t++)if(this.whereClause.finalConditions.length<1)e.push(t);else{for(var n=!1,r=this.whereClause.finalConditions.length;r--;){for(var a=this.whereClause.finalConditions[r],i=!0,s=a.length;s--;){var o=a[s];switch(o.type){case">":(isNaN(parseFloat(this.table.data[t][this.table.colmap[o.col]]))||this.table.data[t][this.table.colmap[o.col]]<o.value)&&(i=!1);break;case"<":(isNaN(parseFloat(this.table.data[t][this.table.colmap[o.col]]))||this.table.data[t][this.table.colmap[o.col]]>o.value)&&(i=!1);break;case"=":this.table.data[t][this.table.colmap[o.col]]!=o.value&&(i=!1);break;case"!=":break;case"%%":this.table.data[t][this.table.colmap[o.col]].indexOf(o.value)<0&&(i=!1);break;case"%-":this.table.data[t][this.table.colmap[o.col]].indexOf(o.value)!=this.table.data[t][this.table.colmap[o.col]].length-o.value.length&&(i=!1);break;case"-%":0!=this.table.data[t][this.table.colmap[o.col]].indexOf(o.value)&&(i=!1)}if(!i)break}if(i){n=!0;break}}n&&e.push(t)}for(var l=[],u=[],h=e.length;h--;)for(var c=e[h],t=this.table.data.length;t--;)t===c?u.push(this.table.data[t]):l.push(this.table.data[t]);return this.table.data=l,this.resultSet=e,this},this.where=function(e){return this.whereClause.where(e)},this.fetch=function(){return null},this.fetchAll=function(){return[]},this.values=function(){throw"values() is not a valid method for a delete query"},this.ifNotExists=function(){throw"ifNotExists() is not a valid method for a delete query"},this.set=function(){throw"set() is not a valid method for a delete query"},this.from=function(){throw"from() is not a valid method for a delete query"}}function jSQLDropQuery(){this.init=function(e){return this.tablename=e,this},this.execute=function(){if(void 0===jSQL.tables[this.tablename])throw"Table "+this.tablename+" does not exist.";return delete jSQL.tables[this.tablename],this},this.fetch=function(){return null},this.fetchAll=function(){return[]},this.values=function(){throw"values() is not a valid method for a drop query"},this.ifNotExists=function(){throw"ifNotExists() is not a valid method for a drop query"},this.set=function(){throw"set() is not a valid method for a drop query"},this.where=function(){throw"where() is not a valid method for a drop query"},this.from=function(){throw"from() is not a valid method for a drop query"}}function jSQLInsertQuery(){this.init=function(e){return this.table=e,this},this.values=function(e){if(void 0===jSQL.tables[this.table])throw"Table: "+this.table+" doesn't exist.";return this.data=e,this},this.execute=function(e){if(void 0!==e&&Array.isArray(e)&&e.length>0)if(Array.isArray(this.data))for(var t=this.data.length;t--&&e.length;)"?"==this.data[t]&&(this.data[t]=e.shift());else for(var t in this.data)this.data.hasOwnProperty(t)&&e.length&&"?"==this.data[t]&&(this.data[t]=e.shift());jSQL.tables[this.table].insertRow(this.data)},this.fetch=function(){return null},this.fetchAll=function(){return[]},this.ifNotExists=function(){throw"ifNotExists() is not a valid method for an insert query"},this.set=function(){throw"set() is not a valid method for an insert query"},this.where=function(){throw"where() is not a valid method for an insert query"},this.from=function(){throw"from() is not a valid method for an insert query"}}function jSQLSelectQuery(){this.init=function(e){return this.columns=Array.isArray(e)?e:[e],this},this.from=function(e){if(void 0===jSQL.tables[e])throw"Table: "+e+" doesn't exist.";return this.table=jSQL.tables[e],"*"==this.columns[0]&&(this.columns=this.table.columns),this},this.where=function(e){return this.whereClause.where(e)},this.execute=function(){for(var e=[],t=0;t<this.table.data.length&&!(this.whereClause.LIMIT>0&&e.length==this.whereClause.LIMIT);t++)if(this.whereClause.finalConditions.length<1){for(var n={},r=0;r<this.columns.length;r++)n[this.columns[r]]=this.table.data[t][this.table.colmap[this.columns[r]]];e.push(n)}else{for(var a=!1,i=this.whereClause.finalConditions.length;i--;){for(var s=this.whereClause.finalConditions[i],o=!0,l=s.length;l--;){var u=s[l];switch(u.type){case">":(isNaN(parseFloat(this.table.data[t][this.table.colmap[u.col]]))||this.table.data[t][this.table.colmap[u.col]]<u.value)&&(o=!1);break;case"<":(isNaN(parseFloat(this.table.data[t][this.table.colmap[u.col]]))||this.table.data[t][this.table.colmap[u.col]]>u.value)&&(o=!1);break;case"=":this.table.data[t][this.table.colmap[u.col]]!=u.value&&(o=!1);break;case"!=":break;case"%%":this.table.data[t][this.table.colmap[u.col]].indexOf(u.value)<0&&(o=!1);break;case"%-":this.table.data[t][this.table.colmap[u.col]].indexOf(u.value)!=this.table.data[t][this.table.colmap[u.col]].length-u.value.length&&(o=!1);break;case"-%":0!=this.table.data[t][this.table.colmap[u.col]].indexOf(u.value)&&(o=!1)}if(!o)break}if(o){a=!0;break}}if(a){for(var n={},r=0;r<this.columns.length;r++)n[this.columns[r]]=this.table.data[t][this.table.colmap[this.columns[r]]];e.push(n)}}return this.whereClause.sortColumn.length>0&&(e.sort(function(e,t){return function n(r){return void 0===this.whereClause.sortColumn[r]?0:e[this.whereClause.sortColumn[r]]<t[this.whereClause.sortColumn[r]]?-1:e[this.whereClause.sortColumn[r]]>t[this.whereClause.sortColumn[r]]?1:n(r+1)}(0)}),"DESC"==this.whereClause.sortDirection&&e.reverse()),this.resultSet=e,this},this.fetch=function(e){if(void 0===e&&(e="ASSOC"),e=e.toUpperCase(),"ASSOC"!==e&&"ARRAY"!==e)throw"Fetch expects paramter one to be 'ASSOC', 'ARRAY', or blank";if(!this.resultSet.length)return!1;var t=this.resultSet.shift();for(var n in t)if(t.hasOwnProperty(n)){var r=this.table.normalizeColumnFetchValue(n,t[n]);t[n]=r}if("ARRAY"==e){var r=[];for(var a in t)t.hasOwnProperty(a)&&r.push(t[a]);t=r}return t},this.fetchAll=function(e){if(void 0===e&&(e="ASSOC"),e=e.toUpperCase(),"ASSOC"!==e&&"ARRAY"!==e)throw"Fetch expects paramter one to be 'ASSOC', 'ARRAY', or blank";if(!this.resultSet.length)return!1;for(var t=[];this.resultSet.length>0;)t.push(this.fetch(e));return t},this.values=function(){throw"values() is not a valid method for a select query"},this.ifNotExists=function(){throw"ifNotExists() is not a valid method for a select query"},this.set=function(){throw"set() is not a valid method for a select query"}}function jSQLUpdateQuery(){this.init=function(e){if(void 0===jSQL.tables[e])throw"Table: "+e+" doesn't exist.";return this.table=this.table=jSQL.tables[e],this},this.set=function(e){this.newvals=e;for(var t in e)e.hasOwnProperty(t)&&this.columns.push(t);return this},this.where=function(e){return this.whereClause.where(e)},this.execute=function(e){if(void 0!==e&&Array.isArray(e))for(var t in this.newvals)this.newvals.hasOwnProperty(t)&&"?"==this.newvals[t]&&e.length&&(this.newvals[t]=e.shift());for(var n=[],t=0;t<this.table.data.length&&!(this.whereClause.LIMIT>0&&n.length==this.whereClause.LIMIT);t++)if(this.whereClause.finalConditions.length<1){for(var r={},a=0;a<this.columns.length;a++)this.table.data[t][this.table.colmap[this.columns[a]]]=this.newvals[this.columns[a]],r[this.columns[a]]=this.table.data[t][this.table.colmap[this.columns[a]]];n.push(r)}else{for(var i=!1,s=this.whereClause.finalConditions.length;s--;){for(var o=this.whereClause.finalConditions[s],l=!0,u=o.length;u--;){var h=o[u];switch(h.type){case">":(isNaN(parseFloat(this.table.data[t][this.table.colmap[h.col]]))||this.table.data[t][this.table.colmap[h.col]]<h.value)&&(l=!1);break;case"<":(isNaN(parseFloat(this.table.data[t][this.table.colmap[h.col]]))||this.table.data[t][this.table.colmap[h.col]]>h.value)&&(l=!1);break;case"=":this.table.data[t][this.table.colmap[h.col]]!=h.value&&(l=!1);break;case"!=":break;case"%%":this.table.data[t][this.table.colmap[h.col]].indexOf(h.value)<0&&(l=!1);break;case"%-":this.table.data[t][this.table.colmap[h.col]].indexOf(h.value)!=this.table.data[t][this.table.colmap[h.col]].length-h.value.length&&(l=!1);break;case"-%":0!=this.table.data[t][this.table.colmap[h.col]].indexOf(h.value)&&(l=!1)}if(!l)break}if(l){i=!0;break}}if(i){for(var r={},a=0;a<this.columns.length;a++)this.table.data[t][this.table.colmap[this.columns[a]]]=this.newvals[this.columns[a]],r[this.columns[a]]=this.table.data[t][this.table.colmap[this.columns[a]]];n.push(r)}}return this.resultSet=n,this},this.fetch=function(){return null},this.fetchAll=function(){return[]},this.values=function(){throw"values() is not a valid method for an update query"},this.ifNotExists=function(){throw"ifNotExists() is not a valid method for an update query"},this.from=function(){throw"from() is not a valid method for an update query"}}function jSQLCreateQuery(){this.init=function(e,t,n){return this.tablename=e,this.columns=t,this.coltypes=n,this},this.ifNotExists=function(){return this.INEFlag=!0,this},this.execute=function(e){return void 0!==e&&(this.data=e),this.INEFlag&&jSQL.tables.hasOwnProperty(this.tablename)||(window.jSQL.tables[this.tablename]=new jSQLTable(this.tablename,this.columns,this.data,this.coltypes)),this},this.fetch=function(){return null},this.fetchAll=function(){return[]},this.values=function(){throw"values() is not a valid method for a create query"},this.set=function(){throw"set() is not a valid method for a create query"},this.where=function(){throw"where() is not a valid method for a create query"},this.from=function(){throw"from() is not a valid method for a create query"}}function jSQLParseQuery(e){var t=function(e){for(var t=['"',"'","`"],n=t.length;n--;)if(e.substr(0,1)==t[n]&&e.substr(e.length-1,1)==t[n])return e.substr(1,e.length-2);return e},n=function(e){for(var n=0;n<jSQL.tables[o].columns.length;n++)if(t(e.toUpperCase())==jSQL.tables[o].columns[n].toUpperCase())return jSQL.tables[o].columns[n];throw e+" column not found in "+o+" table"},r=function(e){for(var t,n=[],r=!1,a=[],i=0;i<e.length;i++)if("'"===e[i]||'"'===e[i])if(r)if(e[i]!==t)a.push(e[i]);else if(i>0&&"\\"===e[i-1])if(i>1&&"\\"===e[i-2]){r=!1,n.push(a.join(""));var a=[]}else a[a.length-1]=e[i];else{r=!1,n.push(a.join(""));var a=[]}else t=e[i],r=!0;else if(r){if("\\"===e[i]&&i>0&&"\\"===e[i-1])continue;a.push(e[i])}else if("?"===e[i])n.push("?");else if(" "!==e[i]&&","!==e[i])return n;return n},a=function(e){for(var n=e.split(","),r={},a="",i=0,s=0;s<n.length;s++){var o=n[s].trim(),l="",u="",h=null,c=!1,f=o.split("");4!==i&&(i=0);for(var p=0;p<f.length;p++){var d=f[p];switch(i){case 0:if("="!==d&&" "!==d)l+=d;else if("="===d)if(" "==f[p+1]&&(p++,d=f[p]),isNaN(f[p+1]))if('"'==f[p+1]||"'"==f[p+1])h=f[p+1],i=1,p++;else{if("?"!=f[p+1])throw"Expected number or quoted string";p++,d=f[p],r[t(l)]="?",i=3}else i=2,c=!0;break;case 1:d===h?"\\"==f[p-1]?u+=d:(r[t(l)]=u,i=3):u+=d;break;case 2:" "==d&&(p++,d=f[p]),isNaN(d)&&"."!=d?(r[t(l)]=parseFloat(u),a+=d,i=3):u+=""+d;break;case 3:if(" "==d&&(p++,d=f[p]),void 0===d)break;i=4,a+=d;break;case 4:a+=d}}""!==u&&(r[t(l)]=c?parseFloat(u):u)}return{newVals:r,whereClause:a}},i=function(e,r){for(;r.length;){var a=r.shift();switch(a.toUpperCase()){case"WHERE":case"AND":var i;try{i=n(r.shift())}catch(s){return new function(e){this.execute=function(){throw e},this.fetch=function(){throw e},this.fetchAll=function(){throw e}}(s.message)}e=e.where(i);break;case"=":e=e.equals(t(r.shift()));break;case">":e=e.greaterThan(t(r.shift()));break;case"<":e=e.lessThan(t(r.shift()));break;case"!=":case"<>":e=e.doesNotEqual(t(r.shift()));break;case"LIKE":var o=t(r.shift());e="%"==o.substr(0,1)&&"%"==o.substr(o.length-1,1)?e.contains(o.substr(1,o.length-2)):"%"==o.substr(0,1)?e.endsWith(o.substr(1,o.length-1)):"%"==o.substr(o.length-1,1)?e.beginsWith(o.substr(0,o.length-1)):"?"===o?e.preparedLike():e.equals(o);break;case"OR":var i;try{i=n(r.shift())}catch(s){throw s.message}e=e.or(i);break;case"LIMIT":e=e.limit(r.shift());break;case"ORDER":if("BY"!=r.shift().toUpperCase())throw"Expected 'ORDER BY', got something else.";for(;r.length>0;){var l=r.shift();try{for(;l.indexOf(",")==l.length-1;)l=l.substr(0,l.length-1);l=n(l),T.push(l)}catch(u){r.unshift(l);break}}e=e.orderBy(T);break;case"ASC":if(!T.length)throw"Must call ORDER BY before using ASC.";e=e.asc();break;case"DESC":if(!T.length)throw"Must call ORDER BY before using DESC.";e=e.desc()}}return e};e=e.replace(/(\r\n|\n|\r)/gm," ").replace(/ +(?= )/g,"").trim();var s=e.split(" ");switch(s.shift().toUpperCase()){case"DELETE":if("FROM"!==s.shift().toUpperCase())throw"Unintelligible query. Expected 'TABLE'";var o=t(s.shift());if(void 0===jSQL.tables[o])throw"Table "+o+" does not exist.";var e=jSQL.deleteFrom(o);return e=i(e,s);case"DROP":if("TABLE"!==s.shift().toUpperCase())throw"Unintelligible query. Expected 'TABLE'";var o=t(s.shift());if(void 0===jSQL.tables[o])throw"Table "+o+" does not exist.";return jSQL.dropTable(o);case"INSERT":var o,l=[],u=[];if("INTO"!==s.shift().toUpperCase())throw"Unintelligible query. Expected 'INTO'";if(o=t(s.shift()),void 0===jSQL.tables[o])throw"Table "+o+" does not exist.";s=m.split("(").join(" ").split(")").join(" ").split(",").join(" ").split("  ").join(" ").trim().split(" ");for(var h=s.shift();s.length&&"VALUES"!==h.toUpperCase();)l.push(t(h)),h=s.shift();if("VALUES"!==h.toUpperCase())throw"Unintelligible query. Expected 'VALUES' near '"+h+"'";var c=s.join(" ");if(u=r(c),!l.length)for(var f=0;f<u.length;f++){if(void 0===jSQL.tables[o].columns[f])throw"Error: too many values.";l.push(jSQL.tables[o].columns[f])}if(u.length!==l.length)throw"Error: Columns mismatch.";for(var p={},f=0;f<l.length;f++)p[l[f]]=u[f];return jSQL.insertInto(o).values(p);case"CREATE":var o,d={},l=[],y=!1;if("TABLE"!==s.shift().toUpperCase())throw"Unintelligible query. Expected 'TABLE'";var m=s.join(" "),w="",g=(m.match(/\(/g)||[]).length,b=(m.match(/\)/g)||[]).length;if(g!==b)throw"Invalid Column definition.";if(g>0&&(w=m.substring(m.indexOf("(")+1,m.lastIndexOf(")"))),s=s.join(" ").split("(").join(" ").split(")").join(" ").split(",").join(" ").split("  ").join(" ").trim().split(" "),o=t(s.shift()),"IF"===o.toUpperCase()){if("NOT"!==s.shift().toUpperCase())throw"Unintelligible query. Expected 'NOT'";if("EXISTS"!==s.shift().toUpperCase())throw"Unintelligible query. Expected 'EXISTS'";o=t(s.shift()),y=!0}d[o]={};for(var v=w.split(","),f=0;f<v.length;f++){for(var m=v[f];(m.match(/\(/g)||[]).length!==(m.match(/\)/g)||[]).length;)m+=","+v[f+1],v[f+1]="",v[f]=m;""!==m.trim()&&l.push(m.trim())}for(var f=0;f<l.length;f++){var S=l[f].split(" "),C=S.shift();if(d[o][C]={type:"AMBI",args:[]},S.length){var Q=S.shift().toUpperCase();if((Q.match(/\(/g)||[]).length){for(;!(Q.match(/\)/g)||[]).length;){if(!S.length)throw"Invalid query, expected ')'";Q+=" "+S.shift()}""!==Q.substring(Q.lastIndexOf(")")+1)&&(S.unshift(Q.substring(Q.lastIndexOf(")")+1)),Q.substring(0,Q.lastIndexOf(")")))}!(Q.match(/\(/g)||[]).length&&S.length&&"("===S[0].charAt(0)&&(Q+=S[0].substring(0,S[0].indexOf(")")+1),S[0]=S[0].substring(S[0].indexOf(")")+1));var E="";if(Q.indexOf("(")>-1){var g=(Q.match(/\(/g)||[]).length,b=(Q.match(/\)/g)||[]).length;if(g!==b)throw"Invalid Arg definition: "+Q;g>0&&(E=Q.substring(Q.indexOf("(")+1,Q.lastIndexOf(")")))}if(""!==E.trim())for(var L=E.split(","),j=0;j<L.length;j++)""!==L[j].trim()&&d[o][C].args.push(L[j].trim());d[o][C].type=Q.split("(")[0].trim().toUpperCase()}}var e=jSQL.createTable(d);return y&&e.ifNotExists(),e;case"UPDATE":var o,e,T=[];o=t(s.shift());var A=s.shift().toUpperCase();if("SET"!==A)throw"Unintelligible query. Expected 'SET.'";var v=a(s.join(" "));return e=jSQL.update(o).set(v.newVals),e=i(e,v.whereClause.split(" "));case"SELECT":var o,x,e,T=[],D=e.toUpperCase().split(" ");D.shift();var I=D.indexOf("FROM");if(0>I)throw"Unintelligible query. Expected 'FROM'";x=s.splice(0,I);for(var f=x.length;f--;)for(;x[f].indexOf(",")==x[f].length-1;)x[f]=x[f].substr(0,x[f].length-1);s.shift(),o=s.shift();for(var O in jSQL.tables)if(jSQL.tables.hasOwnProperty(O)&&O.toUpperCase()==t(o.toUpperCase())){o=O;break}if(void 0===jSQL.tables[o])return new function(e){this.execute=function(){throw e},this.fetch=function(){throw e},this.fetchAll=function(){throw e}}("Table: "+o+" does not exist.");if(1==x.length&&"*"==x[0])x="*";else for(var f=0;f<x.length;f++)try{x[f]=n(x[f])}catch(N){throw N.message}return e=jSQL.select(x).from(o),e=i(e,s);default:throw"Unintelligible query. Error near: "+s[0]}}function jSQLWhereClause(e){var t=this;t.context=e,t.pendingColumn="",t.conditions=[],t.LIMIT=0,t.finalConditions=[],t.sortColumn=[],t.sortDirection="ASC",t.where=function(e){if(""!==t.pendingColumn)throw"Must add a conditional before adding another 'Where' condition.";if("string"!=typeof e)throw"Column name must be a string.";return t.pendingColumn=e,t},t.equals=function(e){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'equals' call.";return t.conditions.push({col:t.pendingColumn,type:"=",value:e}),t.pendingColumn="",t},t.preparedLike=function(){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'preparedLike' call.";return t.conditions.push({col:t.pendingColumn,type:"pl",value:"?"}),t.pendingColumn="",t},t.doesNotEqual=function(e){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'doesNotEqual' call.";return t.conditions.push({col:t.pendingColumn,type:"!=",value:e}),t.pendingColumn="",t},t.lessThan=function(e){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'lessThan' call.";return t.conditions.push({col:t.pendingColumn,type:"<",value:e}),t.pendingColumn="",t},t.greaterThan=function(e){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'greaterThan' call.";return t.conditions.push({col:t.pendingColumn,type:">",value:e}),t.pendingColumn="",t},t.contains=function(e){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'contains' call.";return t.conditions.push({col:t.pendingColumn,type:"%%",value:e}),t.pendingColumn="",t},t.endsWith=function(e){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'endsWith' call.";return t.conditions.push({col:t.pendingColumn,type:"%-",value:e}),t.pendingColumn="",t},t.beginsWith=function(e){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'beginsWith' call.";return t.conditions.push({col:t.pendingColumn,type:"-%",value:e}),t.pendingColumn="",t},t.and=function(e){return t.where(e)},t.or=function(e){return t.finalConditions.push(t.conditions),t.conditions=[],t.where(e)},t.limit=function(e){return t.LIMIT=parseInt(e),t},t.orderBy=function(e){return Array.isArray(e)||(e=[e]),t.sortColumn=e,t},t.asc=function(){if(""==t.sortColumn)throw"Must use orderBy clause before using ASC";return t.sortDirection="ASC",t},t.desc=function(){if(""==t.sortColumn)throw"Must use orderBy clause before using DESC";return t.sortDirection="DESC",t},t.execute=function(e){if(void 0===e&&(e=[]),t.conditions.length>0&&t.finalConditions.push(t.conditions),e.length>0)for(var n=t.finalConditions.length;n--;)for(var r=t.finalConditions[n].length;r--;)if("?"===t.finalConditions[n][r].value&&"pl"===t.finalConditions[n][r].type){var a=e.pop();"%"==a.substr(0,1)&&"%"==a.substr(a.length-1,1)?(t.finalConditions[n][r].value=a.substr(1,a.length-2),t.finalConditions[n][r].type="%%"):"%"==a.substr(0,1)?(t.finalConditions[n][r].value=a.substr(1,a.length-1),t.finalConditions[n][r].type="%-"):"%"==a.substr(a.length-1,1)?(t.finalConditions[n][r].value=a.substr(0,a.length-1),t.finalConditions[n][r].type="-%"):(t.finalConditions[n][r].value=a,t.finalConditions[n][r].type="=")}else"?"===t.finalConditions[n][r].value&&e.length>0&&(t.finalConditions[n][r].value=e.pop());return t.context.execute(e)},t.fetch=function(e){return t.context.fetch(e)},t.fetchAll=function(e){return t.context.fetchAll(e)}}function WebSQLAPI(){var e=this;e.db=null;var t=function(t,n,r,a){"function"!=typeof r&&(r=function(){}),"function"!=typeof a&&(a=function(){throw"Could not execute query: "+t});var i,s,o;Array.isArray(n[0])||(n=[n]),o=n.length;var l=function(e,t){var n,a,i=[];if(o-=1,!o){for(n=0,a=t.rows.length;a>n;n+=1){var s=t.rows.item(n).json;i.push(s)}r(i)}};e.db.transaction(function(e){for(i=0,s=n.length;s>i;i+=1)e.executeSql(t,n[i],l,a)})};e.init=function(n,r){"function"!=typeof r&&(r=function(){});var a=function(){try{for(var r=n.length;r--;)(function(n,r){t("DROP TABLE IF EXISTS "+n,[],function(){t("CREATE TABLE IF NOT EXISTS "+n+"(json TEXT)",[],function(){e.insert(n,r)})})})(n[r].name,n[r].rows)}catch(a){throw"Error creating table"}};try{var i=window.location.href.replace(/\W+/g,"");e.db=openDatabase("jSQL_"+i,"1.0","jSQL "+i,5242880)}catch(s){throw"Error opening database"}t("SELECT COUNT(*) FROM "+n[0].name,[],null,function(){a()}),r()},e.insert=function(e,n,r){"function"!=typeof r&&(r=function(){});var a,i,s=n.length,o=[];for(0===s&&r(),a=0,i=n.length;i>a;a+=1)o[a]=[JSON.stringify(n[a])];t("INSERT INTO "+e+" (json) VALUES (?);",o,r)},e["delete"]=function(e,n){"function"!=typeof n&&(n=function(){}),t("DELETE FROM "+e,[],n)},e.select=function(e,n){t("SELECT json FROM "+e,[],function(e){for(var t=[],r=e.length;r--;)t.push(JSON.parse(e[r]));n(t)})}}function indexedDBAPI(){var e=this;e.db=null;var t,n,r;e.init=function(a,i){"function"!=typeof i&&(i=function(){});try{t=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,n=window.hasOwnProperty("webkitIndexedDB")?window.webkitIDBTransaction:window.IDBTransaction,r=window.hasOwnProperty("webkitIndexedDB")?window.webkitIDBKeyRange:window.IDBKeyRange}catch(s){throw"indexedDB is not supported in this browser"}if(!t)throw"indexedDB is not supported in this browser";var o=1,l=window.location.href.replace(/\W+/g,""),u=t.open("jSQL_"+l,o),h=function(){for(var t=a.length;t--;)e.db.objectStoreNames.contains(a[t].name)&&e.db.deleteObjectStore(a[t].name),e.db.createObjectStore(a[t].name,{keyPath:"_id",autoIncrement:!0});var n=0,r=!1,i=setInterval(function(){if(!r){r=!0;try{for(var t=a.length;t--;){var s=a[t].name,o=void 0==a[t].rows?[]:a[t].rows;e.insert(s,o)}clearInterval(i)}catch(l){if(n>1e3)throw clearInterval(i),"Could not add data after 10 seconds.";r=!1}}},10)};u.onsuccess=function(t){var n;e.db=t.target.result,o=String(o),e.db.setVersion&&o!==e.db.version?(n=e.db.setVersion(o),n.onfailure=function(){throw"Error updating datastore version"},n.onsuccess=function(e){h(),n.result.oncomplete=function(){i()}}):i()},u.onupgradeneeded=function(t){e.db=t.target.result,h()},u.onerror=function(e){throw"Could not connect to the indexedDB datastore.";
}},e.insert=function(t,r,a){"function"!=typeof a&&(a=function(){});var i,s,o,l=e.db.transaction([t],n.READ_WRITE||"readwrite"),u=r.length,h=function(){u-=1,0===u&&a(u)};l.onerror=function(){throw"Could not initiate a transaction"},i=l.objectStore(t);for(s in r)r.hasOwnProperty(s)&&(o=i.add(r[s]),o.onsuccess=h,o.onerror=function(){throw"Could not initiate a request"})},e["delete"]=function(t,r){"function"!=typeof r&&(r=function(){});var a,i,s=e.db.transaction([t],n.READ_WRITE||"readwrite");s.onerror=function(){throw"Could not initiate a transaction"},a=s.objectStore(t),i=a.clear(),i.onerror=function(){throw"Could not initiate a request"},i.onsuccess=r},e.select=function(t,r){"function"!=typeof r&&(r=function(){});var a,i,s=e.db.transaction([t],n.READ_ONLY||"readonly"),o=[];s.onerror=function(){throw"Could not initiate a transaction"},a=s.objectStore(t),i=a.openCursor(),i.onerror=function(){throw"Could not initiate a request"};var l=!1;i.onsuccess=function(e){if(!l){var t=e.target.result;return t?(o.push(t.value),void t["continue"]()):(l=!0,void r(o))}}}}function createTable(e,t,n){if(void 0===t&&void 0===n&&"object"==typeof e){t=[],n=[];for(var r in e)if(e.hasOwnProperty(r)){var a=e[r];e=r;for(var i in a)a.hasOwnProperty(i)&&(t.push(i),n.push({type:a[i].type,args:void 0===a[i].args?[]:a[i].args}));break}}return Array.isArray(t)||(t=[t]),new jSQLQuery("CREATE").init(e,t,n)}function select(e){return Array.isArray(e)||(e=[e]),new jSQLQuery("SELECT").init(e)}function update(e){return new jSQLQuery("UPDATE").init(e)}function insertInto(e){return new jSQLQuery("INSERT").init(e)}function dropTable(e){return new jSQLQuery("DROP").init(e)}function deleteFrom(e){return new jSQLQuery("DELETE").init(e)}var persistenceManager=new function(){var e=this;e.api=null,e.error=!1,e.persist=function(t){if("function"==typeof t&&(t=function(){}),e.error!==!1)throw e.error;var n=[];for(var r in jSQL.tables)if(jSQL.tables.hasOwnProperty(r))for(var a=jSQL.select("*").from(r).execute().fetchAll(),i=a.length;i--;){var s=a[i];for(var o in s)s.hasOwnProperty(o)&&(s[o]=jSQL.tables[r].normalizeColumnStoreValue(o,s[o]));n.push({table:r,data:JSON.stringify(s),colTypes:JSON.stringify(jSQL.tables[r].types)})}e.api["delete"]("jSQL_data_schema",function(){e.api.insert("jSQL_data_schema",n,t)})},e.load=function(t){"function"!=typeof t&&(t=function(){}),function n(r){try{e.api.select("jSQL_data_schema",function(e){if(jSQL.tables={},0===e.length)return t();for(var n=e.length;n--;){var r=e[n].table,a=JSON.parse(e[n].data),i=JSON.parse(e[n].colTypes);if(void 0===jSQL.tables[r]){var s=[];for(var o in a)a.hasOwnProperty(o)&&s.push(o);jSQL.createTable(r,s,i).execute()}for(var o in a)a.hasOwnProperty(o)&&(a[o]=jSQL.tables[r].normalizeColumnFetchValue(o,a[o]));jSQL.tables[r].insertRow(a)}return t()})}catch(a){if(r>500)return t();setTimeout(function(){n(r+1)},10)}}(0)},function(){try{e.api=new indexedDBAPI,e.api.init([{name:"jSQL_data_schema",rows:[]}])}catch(t){try{e.api=new WebSQLAPI,e.api.init([{name:"jSQL_data_schema",rows:[]}])}catch(n){e.error="Browser doesn't support Web SQL or IndexedDB"}}}()};return{tables:{},query:jSQLParseQuery,createTable:createTable,dropTable:dropTable,select:select,update:update,deleteFrom:deleteFrom,insertInto:insertInto,types:new jSQLDataTypeList,persist:persistenceManager.persist,load:persistenceManager.load}}();