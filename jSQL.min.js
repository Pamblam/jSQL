/* jSQL - @license - WTFPL v2 wtfpl.net */
window.jSQL=function(){"use strict";function t(t,n,e){var o=this;o.name="",o.columns=[],o.data=[],o.colmap={},o.init=function(t,n,e){if(o.name=t,Array.isArray(n)&&void 0===e&&(e=n,n=[]),Array.isArray(n)&&!Array.isArray(n[0])&&"object"==typeof n[0]){var r=[];for(var t in n[0])n[0].hasOwnProperty(t)&&r.push(t);e=n,n=r}if(!Array.isArray(n))throw"Columns must be an array.";o.columns=n;for(var i=0;i<n.length;i++)o.colmap[n[i]]=i;void 0!==e&&o.loadData(e)},o.renameColumn=function(t,n){if(void 0===t||"string"!=typeof n)throw"renameColumn expects and old column name and a new one, both must be strings.";if(o.columns.indexOf(t)<0)throw"The column "+t+" does not exist in this table.";o.columns.splice(o.columns.indexOf(t),1,n)},o.addColumn=function(t,n){void 0===n&&(n=null),"string"!=typeof t&&(t=function r(t){for(var n=0;n<o.columns.length;n++)if(o.columns[n]=="u"+t)return r(t+1);return"u"+t}(0)),o.columns.push(t);for(var e=o.data.length;e--;)o.data[e].push(n);o.colmap[t]=o.columns.length-1},o.loadData=function(t){if(!Array.isArray(t))throw"Data must be an array.";var n=t.length;for(o.columns.length;n--;)o.insertRow(t[n])},o.insertRow=function(t){var n=[];if(Array.isArray(t)){for(;t.length>o.columns.length;)o.addColumn();for(;t.length<o.columns.length;)t.push(null);for(var e=0;e<t.length;e++)n.push(t[e]);for(;n.length<o.columns.length;)n.push(null)}else{if("object"!=typeof t)throw"Data not structured properly.";for(var e=0;e<o.columns.length;e++)void 0===t[o.columns[e]]&&(t[o.columns[e]]=null);for(var r in t)if(function(t){for(;t--;)if(o.columns[t]==r)return 0;return 1}(o.columns.length))if(o.columns.indexOf("u0")>-1){o.renameColumn("u0",r);for(var i=1;o.columns.indexOf("u"+i)>-1;)o.renameColumn("u"+i,"u"+(i-1))}else o.addColumn(r);for(var e=0;e<o.columns.length;e++)n.push(t[o.columns[e]])}o.data.push(n)},o.init(t,n,e)}function n(t){t=t.replace(/(\r\n|\n|\r)/gm," ").replace(/ +(?= )/g,"").trim();var n=t.split(" "),e=function(t){for(var n=['"',"'","`"],e=n.length;e--;)if(t.substr(0,1)==n[e]&&t.substr(t.length-1,1)==n[e])return t.substr(1,t.length-2);return t};switch(n.shift().toUpperCase()){case"INSERT":var o,r=[],i=[];if("INTO"!==n.shift().toUpperCase())throw"Unintelligible query. Expected 'INTO'";if(o=n.shift(),void 0===jSQL.tables[o])throw"Table "+o+" does not exist.";n=n.join(" ").split("(").join(" ").split(")").join(" ").split(",").join(" ").split("  ").join(" ").trim().split(" ");for(var a=n.shift();n.length&&"VALUES"!==a.toUpperCase();)r.push(e(a)),a=n.shift();if("VALUES"!==a.toUpperCase())throw"Unintelligible query. Expected 'VALUES' near '"+a+"'";for(;n.length;)i.push(e(n.shift()));if(!r.length)for(var s=0;s<i.length;s++){if(void 0===jSQL.tables[o].columns[s])throw"Error: too many values.";r.push(jSQL.tables[o].columns[s])}if(i.length!==r.length)throw"Error: Columns mismatch.";for(var l={},s=0;s<r.length;s++)l[r[s]]=i[s];return jSQL.tables[o].insertRow(l),new function(){this.execute=function(){return this},this.fetch=function(){return null},this.fetchAll=function(){return[]}};case"CREATE":var o,r=[];if("TABLE"!==n.shift().toUpperCase())throw"Unintelligible query. Expected 'TABLE'";if(n=n.join(" ").split("(").join(" ").split(")").join(" ").split(",").join(" ").split("  ").join(" ").trim().split(" "),o=e(n.shift()),"IF"===o.toUpperCase()){if("NOT"!==n.shift().toUpperCase())throw"Unintelligible query. Expected 'NOT'";if("EXISTS"!==n.shift().toUpperCase())throw"Unintelligible query. Expected 'EXISTS'";if(o=e(n.shift()),jSQL.tables.hasOwnProperty(o))return}for(;n.length>0;)r.push(e(n.shift()));return jSQL.createTable(o,r,[]),new function(){this.execute=function(){return this},this.fetch=function(){return null},this.fetchAll=function(){return[]}};case"SELECT":var o,u,t,c=[],f=t.toUpperCase().split(" ");f.shift();var h=f.indexOf("FROM");if(0>h)throw"Unintelligible query. Expected 'FROM'";u=n.splice(0,h);for(var s=u.length;s--;)for(;u[s].indexOf(",")==u[s].length-1;)u[s]=u[s].substr(0,u[s].length-1);n.shift(),o=n.shift();for(var d in jSQL.tables)if(jSQL.tables.hasOwnProperty(d)&&d.toUpperCase()==e(o.toUpperCase())){o=d;break}if(void 0===jSQL.tables[o])throw"Table: "+o+" does not exist.";var p=function(t){for(var n=0;n<jSQL.tables[o].columns.length;n++)if(e(t.toUpperCase())==jSQL.tables[o].columns[n].toUpperCase())return jSQL.tables[o].columns[n];throw t+" column not found in "+o+" table"};if(1==u.length&&"*"==u[0])u="*";else for(var s=0;s<u.length;s++)u[s]=p(u[s]);for(t=jSQL.select(u).from(o);n.length;){var b=n.shift();switch(b.toUpperCase()){case"WHERE":case"AND":t=t.where(p(n.shift()));break;case"=":t=t.equals(e(n.shift()));break;case">":t=t.greaterThan(e(n.shift()));break;case"<":t=t.lessThan(e(n.shift()));break;case"!=":case"<>":t=t.doesNotEqual(e(n.shift()));break;case"LIKE":var m=e(n.shift());t="%"==m.substr(0,1)&&"%"==m.substr(m.length-1,1)?t.contains(m.substr(1,m.length-2)):"%"==m.substr(0,1)?t.endsWith(m.substr(1,m.length-1)):"%"==m.substr(m.length-1,1)?t.beginsWith(m.substr(0,m.length-1)):t.equals(m);break;case"OR":t=t.or(p(n.shift()));break;case"LIMIT":t=t.limit(n.shift());break;case"ORDER":if("BY"!=n.shift().toUpperCase())throw"Expected 'ORDER BY', got something else.";for(;n.length>0;){var g=n.shift();try{for(;g.indexOf(",")==g.length-1;)g=g.substr(0,g.length-1);g=p(g),c.push(g)}catch(w){n.unshift(g);break}}t=t.orderBy(c);break;case"ASC":if(!c.length)throw"Must call ORDER BY before using ASC.";t=t.asc();break;case"DESC":if(!c.length)throw"Must call ORDER BY before using DESC.";t=t.desc();break;default:throw"Unintelligible query. Near: "+b}}return t;default:throw"Unintelligible query. Error near: "+n[0]}}function e(t){var n=this;n.table=t,n.values=function(e){if(void 0===jSQL.tables[t])throw"Table: "+n.table+" doesn't exist.";return jSQL.tables[t].insertRow(e),!0}}function o(t){var n=this;n.columns=t,n.from=function(t){if(void 0===jSQL.tables[t])throw"Table: "+t+" doesn't exist.";return new r(jSQL.tables[t],n.columns)}}function r(t,n){var e=this;e.table=null,e.columns=[],e.pendingColumn="",e.conditions=[],e.LIMIT=0,e.finalConditions=[],e.sortColumn=[],e.sortDirection="ASC",e.resultSet=[],e.init=function(t,n){if(e.table=t,"string"==typeof n&&(n=[n]),!Array.isArray(n))throw"Select requires a string or an array of column names.";"*"==n[0]&&(n=e.table.columns);for(var o=0;o<n.length;o++){if(e.table.columns.indexOf(n[o])<0)throw"There is no "+n[o]+" column in the "+e.table.name+" table.";e.columns.push(n[o])}},e.where=function(t){if(""!==e.pendingColumn)throw"Must add a conditional before adding another 'Where' condition.";if("string"!=typeof t)throw"Column name must be a string.";if(e.table.columns.indexOf(t)<0)throw"There is no "+t+" column in the "+e.table.name+" table.";return e.pendingColumn=t,e},e.equals=function(t){if(""==e.pendingColumn)throw"Must add a 'where' clause before the 'equals' call.";return e.conditions.push({col:e.pendingColumn,type:"=",value:t}),e.pendingColumn="",e},e.doesNotEqual=function(t){if(""==e.pendingColumn)throw"Must add a 'where' clause before the 'doesNotEqual' call.";return e.conditions.push({col:e.pendingColumn,type:"!=",value:t}),e.pendingColumn="",e},e.lessThan=function(t){if(""==e.pendingColumn)throw"Must add a 'where' clause before the 'lessThan' call.";return e.conditions.push({col:e.pendingColumn,type:"<",value:t}),e.pendingColumn="",e},e.greaterThan=function(t){if(""==e.pendingColumn)throw"Must add a 'where' clause before the 'greaterThan' call.";return e.conditions.push({col:e.pendingColumn,type:">",value:t}),e.pendingColumn="",e},e.contains=function(t){if(""==e.pendingColumn)throw"Must add a 'where' clause before the 'contains' call.";return e.conditions.push({col:e.pendingColumn,type:"%%",value:t}),e.pendingColumn="",e},e.endsWith=function(t){if(""==e.pendingColumn)throw"Must add a 'where' clause before the 'endsWith' call.";return e.conditions.push({col:e.pendingColumn,type:"%-",value:t}),e.pendingColumn="",e},e.beginsWith=function(t){if(""==e.pendingColumn)throw"Must add a 'where' clause before the 'beginsWith' call.";return e.conditions.push({col:e.pendingColumn,type:"-%",value:t}),e.pendingColumn="",e},e.and=function(t){return e.where(t)},e.or=function(t){return e.finalConditions.push(e.conditions),e.conditions=[],e.where(t)},e.limit=function(t){return e.LIMIT=parseInt(t),e},e.orderBy=function(t){Array.isArray(t)||(t=[t]);for(var n=t.length;n--;)if(e.table.columns.indexOf(t[n])<0)throw"There is no "+t[n]+" column in the "+e.table.name+" table.";return e.sortColumn=t,e},e.asc=function(){if(""==e.sortColumn)throw"Must use orderBy clause before using ASC";return e.sortDirection="ASC",e},e.desc=function(){if(""==e.sortColumn)throw"Must use orderBy clause before using DESC";return e.sortDirection="DESC",e},e.execute=function(){var t=[];e.conditions.length>0&&e.finalConditions.push(e.conditions);for(var n=0;n<e.table.data.length&&!(e.LIMIT>0&&t.length==e.LIMIT);n++)if(e.finalConditions.length<1){for(var o={},r=0;r<e.columns.length;r++)o[e.columns[r]]=e.table.data[n][r];t.push(o)}else{for(var i=!1,a=e.finalConditions.length;a--;){for(var s=e.finalConditions[a],l=!0,u=s.length;u--;){var c=s[u];switch(c.type){case">":(isNaN(parseFloat(e.table.data[n][e.table.colmap[c.col]]))||e.table.data[n][e.table.colmap[c.col]]<c.value)&&(l=!1);break;case"<":(isNaN(parseFloat(e.table.data[n][e.table.colmap[c.col]]))||e.table.data[n][e.table.colmap[c.col]]>c.value)&&(l=!1);break;case"=":e.table.data[n][e.table.colmap[c.col]]!=c.value&&(l=!1);break;case"!=":break;case"%%":e.table.data[n][e.table.colmap[c.col]].indexOf(c.value)<0&&(l=!1);break;case"%-":e.table.data[n][e.table.colmap[c.col]].indexOf(c.value)!=e.table.data[n][e.table.colmap[c.col]].length-c.value.length&&(l=!1);break;case"-%":0!=e.table.data[n][e.table.colmap[c.col]].indexOf(c.value)&&(l=!1)}if(!l)break}if(l){i=!0;break}}if(i){for(var o={},r=0;r<e.columns.length;r++)o[e.columns[r]]=e.table.data[n][r];t.push(o)}}return e.sortColumn.length>0&&(t.sort(function(t,n){return function o(r){return void 0===e.sortColumn[r]?0:t[e.sortColumn[r]]<n[e.sortColumn[r]]?-1:t[e.sortColumn[r]]>n[e.sortColumn[r]]?1:o(r+1)}(0)}),"DESC"==e.sortDirection&&t.reverse()),e.resultSet=t,e},e.fetch=function(t){if(void 0===t&&(t="ASSOC"),t=t.toUpperCase(),"ASSOC"!==t&&"ARRAY"!==t)throw"Fetch expects paramter one to be 'ASSOC', 'ARRAY', or blank";if(!e.resultSet.length)return!1;var n=e.resultSet.shift();if("ARRAY"==t){var o=[];for(var r in n)n.hasOwnProperty(r)&&o.push(n[r]);n=o}return n},e.fetchAll=function(t){if(void 0===t&&(t="ASSOC"),t=t.toUpperCase(),"ASSOC"!==t&&"ARRAY"!==t)throw"Fetch expects paramter one to be 'ASSOC', 'ARRAY', or blank";if(!e.resultSet.length)return!1;for(var n=[];e.resultSet.length>0;)n.push(e.fetch(t));return n},e.init(t,n)}function i(n,e,o){return window.jSQL.tables[n]=new t(n,e,o),!0}function a(t){return new o(t)}function s(t){return new e(t)}function l(){var t=this;t.db=null;var n=function(n,e,o,r){"function"!=typeof o&&(o=function(){}),"function"!=typeof r&&(r=function(){throw"Could not execute query: "+n});var i,a,s;Array.isArray(e[0])||(e=[e]),s=e.length;var l=function(t,n){var e,r,i=[];if(s-=1,!s){for(e=0,r=n.rows.length;r>e;e+=1){var a=n.rows.item(e).json;i.push(a)}o(i)}};t.db.transaction(function(t){for(i=0,a=e.length;a>i;i+=1)t.executeSql(n,e[i],l,r)})};t.init=function(e,o){"function"!=typeof o&&(o=function(){});var r=function(){try{for(var o=e.length;o--;)(function(e,o){n("DROP TABLE IF EXISTS "+e,[],function(){n("CREATE TABLE IF NOT EXISTS "+e+"(json TEXT)",[],function(){t.insert(e,o)})})})(e[o].name,e[o].rows)}catch(r){throw"Error creating table"}};try{var i=window.location.href.replace(/\W+/g,"");t.db=openDatabase("jSQL_"+i,"1.0","jSQL "+i,5242880)}catch(a){throw"Error opening database"}n("SELECT COUNT(*) FROM "+e[0].name,[],null,function(){r()}),o()},t.insert=function(t,e,o){"function"!=typeof o&&(o=function(){});var r,i,a=e.length,s=[];for(0===a&&o(),r=0,i=e.length;i>r;r+=1)s[r]=[JSON.stringify(e[r])];n("INSERT INTO "+t+" (json) VALUES (?);",s,o)},t["delete"]=function(t,e){"function"!=typeof e&&(e=function(){}),n("DELETE FROM "+t,[],e)},t.select=function(t,e){n("SELECT json FROM "+t,[],function(t){for(var n=[],o=t.length;o--;)n.push(JSON.parse(t[o]));e(n)})}}function u(){var t=this;t.db=null;var n,e,o;t.init=function(r,i){"function"!=typeof i&&(i=function(){});try{n=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,e=window.hasOwnProperty("webkitIndexedDB")?window.webkitIDBTransaction:window.IDBTransaction,o=window.hasOwnProperty("webkitIndexedDB")?window.webkitIDBKeyRange:window.IDBKeyRange}catch(a){throw"indexedDB is not supported in this browser"}if(!n)throw"indexedDB is not supported in this browser";var s=1,l=window.location.href.replace(/\W+/g,""),u=n.open("jSQL_"+l,s),c=function(){for(var n=r.length;n--;)t.db.objectStoreNames.contains(r[n].name)&&t.db.deleteObjectStore(r[n].name),t.db.createObjectStore(r[n].name,{keyPath:"_id",autoIncrement:!0});var e=0,o=!1,i=setInterval(function(){if(!o){o=!0;try{for(var n=r.length;n--;){var a=r[n].name,s=void 0==r[n].rows?[]:r[n].rows;t.insert(a,s)}clearInterval(i)}catch(l){if(e>1e3)throw clearInterval(i),"Could not add data after 10 seconds.";o=!1}}},10)};u.onsuccess=function(n){var e;t.db=n.target.result,s=String(s),t.db.setVersion&&s!==t.db.version?(e=t.db.setVersion(s),e.onfailure=function(){throw"Error updating datastore version"},e.onsuccess=function(t){c(),e.result.oncomplete=function(){i()}}):i()},u.onupgradeneeded=function(n){t.db=n.target.result,c()},u.onerror=function(t){throw"Could not connect to the indexedDB datastore."}},t.insert=function(n,o,r){"function"!=typeof r&&(r=function(){});var i,a,s,l=t.db.transaction([n],e.READ_WRITE||"readwrite"),u=o.length,c=function(){u-=1,0===u&&r(u)};l.onerror=function(){throw"Could not initiate a transaction"},i=l.objectStore(n);for(a in o)o.hasOwnProperty(a)&&(s=i.add(o[a]),s.onsuccess=c,s.onerror=function(){throw"Could not initiate a request"})},t["delete"]=function(n,o){"function"!=typeof o&&(o=function(){});var r,i,a=t.db.transaction([n],e.READ_WRITE||"readwrite");a.onerror=function(){throw"Could not initiate a transaction"},r=a.objectStore(n),i=r.clear(),i.onerror=function(){throw"Could not initiate a request"},i.onsuccess=o},t.select=function(n,o){"function"!=typeof o&&(o=function(){});var r,i,a=t.db.transaction([n],e.READ_ONLY||"readonly"),s=[];a.onerror=function(){throw"Could not initiate a transaction"},r=a.objectStore(n),i=r.openCursor(),i.onerror=function(){throw"Could not initiate a request"};var l=!1;i.onsuccess=function(t){if(!l){var n=t.target.result;return n?(s.push(n.value),void n["continue"]()):(l=!0,void o(s))}}}}var c=new function(){var t=this;t.api=null,t.error=!1,t.persist=function(n){if("function"==typeof n&&(n=function(){}),t.error!==!1)throw t.error;var e=[];for(var o in jSQL.tables)if(jSQL.tables.hasOwnProperty(o))for(var r=jSQL.select("*").from(o).execute().fetchAll(),i=r.length;i--;){var a=r[i];for(var s in a)a.hasOwnProperty(s)&&"function"==typeof a[s]&&(a[s]="#jSQLFunct#"+a[s].toString());e.push({table:o,data:JSON.stringify(a)})}t.api["delete"]("jSQL_data_schema",function(){t.api.insert("jSQL_data_schema",e,n)})},t.load=function(n){"function"!=typeof n&&(n=function(){}),function e(o){try{t.api.select("jSQL_data_schema",function(t){if(jSQL.tables={},0===t.length)return n();for(var e=t.length;e--;){var o=t[e].table,r=JSON.parse(t[e].data);if(void 0===jSQL.tables[o]){var i=[];for(var a in r)r.hasOwnProperty(a)&&i.push(a);jSQL.createTable(o,i,[])}for(var a in r)r.hasOwnProperty(a)&&"string"==typeof r[a]&&0===r[a].indexOf("#jSQLFunct#")&&(r[a]=exec(r[a].substr(11)));jSQL.tables[o].insertRow(r)}return n()})}catch(r){if(o>500)return n();setTimeout(function(){e(o+1)},10)}}(0)},function(){try{t.api=new u,t.api.init([{name:"jSQL_data_schema",rows:[]}])}catch(n){try{t.api=new l,t.api.init([{name:"jSQL_data_schema",rows:[]}])}catch(e){t.error="Browser doesn't support Web SQL or IndexedDB"}}}()};return{tables:{},query:n,createTable:i,select:a,insertInto:s,persist:c.persist,load:c.load}}();