/* jSQL - @license - WTFPL v2 wtfpl.net */
window.jSQL=function(){"use strict";function n(n,e,t){var o=this;o.name="",o.columns=[],o.data=[],o.colmap={},o.init=function(n,e,t){if(o.name=n,Array.isArray(e)&&void 0===t&&(t=e,e=[]),Array.isArray(e)&&!Array.isArray(e[0])&&"object"==typeof e[0]){var r=[];for(var n in e[0])e[0].hasOwnProperty(n)&&r.push(n);t=e,e=r}if(!Array.isArray(e))throw"Columns must be an array.";o.columns=e;for(var a=0;a<e.length;a++)o.colmap[e[a]]=a;void 0!==t&&o.loadData(t)},o.renameColumn=function(n,e){if(void 0===n||"string"!=typeof e)throw"renameColumn expects and old column name and a new one, both must be strings.";if(o.columns.indexOf(n)<0)throw"The column "+n+" does not exist in this table.";o.columns.splice(o.columns.indexOf(n),1,e)},o.addColumn=function(n,e){void 0===e&&(e=null),"string"!=typeof n&&(n=function r(n){for(var e=0;e<o.columns.length;e++)if(o.columns[e]=="u"+n)return r(n+1);return"u"+n}(0)),o.columns.push(n);for(var t=o.data.length;t--;)o.data[t].push(e);o.colmap[n]=o.columns.length-1},o.loadData=function(n){if(!Array.isArray(n))throw"Data must be an array.";var e=n.length;for(o.columns.length;e--;)o.insertRow(n[e])},o.insertRow=function(n){var e=[];if(Array.isArray(n)){for(;n.length>o.columns.length;)o.addColumn();for(;n.length<o.columns.length;)n.push(null);for(var t=0;t<n.length;t++)e.push(n[t]);for(;e.length<o.columns.length;)e.push(null)}else{if("object"!=typeof n)throw"Data not structured properly.";for(var t=0;t<o.columns.length;t++)void 0===n[o.columns[t]]&&(n[o.columns[t]]=null);for(var r in n)if(function(n){for(;n--;)if(o.columns[n]==r)return 0;return 1}(o.columns.length))if(o.columns.indexOf("u0")>-1){o.renameColumn("u0",r);for(var a=1;o.columns.indexOf("u"+a)>-1;)o.renameColumn("u"+a,"u"+(a-1))}else o.addColumn(r);for(var t=0;t<o.columns.length;t++)e.push(n[o.columns[t]])}o.data.push(e)},o.init(n,e,t)}function e(n){n=n.replace(/(\r\n|\n|\r)/gm," ").replace(/ +(?= )/g,"").trim();var e=n.split(" "),t=function(n){for(var e=['"',"'","`"],t=e.length;t--;)if(n.substr(0,1)==e[t]&&n.substr(n.length-1,1)==e[t])return n.substr(1,n.length-2);return n};switch(e.shift().toUpperCase()){case"INSERT":console.log("@todo parse INSERT statement");break;case"CREATE":var o,r=[];if("TABLE"!==e.shift().toUpperCase())throw"Unintelligible query. Expected 'TABLE'";if(e=e.join(" ").split("(").join(" ").split(")").join(" ").split(",").join(" ").split("  ").join(" ").trim().split(" "),o=t(e.shift()),"IF"===o.toUpperCase()){if("NOT"!==e.shift().toUpperCase())throw"Unintelligible query. Expected 'NOT'";if("EXISTS"!==e.shift().toUpperCase())throw"Unintelligible query. Expected 'EXISTS'";if(o=t(e.shift()),jSQL.tables.hasOwnProperty(o))return}for(;e.length>0;)r.push(t(e.shift()));return jSQL.createTable(o,r,[]),new function(){this.execute=function(){return this},this.fetch=function(){return null},this.fetchAll=function(){return[]}};case"SELECT":var o,a,n,i=[],s=n.toUpperCase().split(" ");s.shift();var l=s.indexOf("FROM");if(0>l)throw"Unintelligible query. Expected 'FROM'";a=e.splice(0,l);for(var u=a.length;u--;)for(;a[u].indexOf(",")==a[u].length-1;)a[u]=a[u].substr(0,a[u].length-1);e.shift(),o=e.shift();for(var c in jSQL.tables)if(jSQL.tables.hasOwnProperty(c)&&c.toUpperCase()==t(o.toUpperCase())){o=c;break}if(void 0===jSQL.tables[o])throw"Table: "+o+" does not exist.";var f=function(n){for(var e=0;e<jSQL.tables[o].columns.length;e++)if(t(n.toUpperCase())==jSQL.tables[o].columns[e].toUpperCase())return jSQL.tables[o].columns[e];throw n+" column not found in "+o+" table"};if(1==a.length&&"*"==a[0])a="*";else for(var u=0;u<a.length;u++)a[u]=f(a[u]);for(n=jSQL.select(a).from(o);e.length;){var h=e.shift();switch(h.toUpperCase()){case"WHERE":case"AND":n=n.where(f(e.shift()));break;case"=":n=n.equals(t(e.shift()));break;case">":n=n.greaterThan(t(e.shift()));break;case"<":n=n.lessThan(t(e.shift()));break;case"!=":case"<>":n=n.doesNotEqual(t(e.shift()));break;case"LIKE":var d=t(e.shift());n="%"==d.substr(0,1)&&"%"==d.substr(d.length-1,1)?n.contains(d.substr(1,d.length-2)):"%"==d.substr(0,1)?n.endsWith(d.substr(1,d.length-1)):"%"==d.substr(d.length-1,1)?n.beginsWith(d.substr(0,d.length-1)):n.equals(d);break;case"OR":n=n.or(f(e.shift()));break;case"LIMIT":n=n.limit(e.shift());break;case"ORDER":if("BY"!=e.shift().toUpperCase())throw"Expected 'ORDER BY', got something else.";for(;e.length>0;){var p=e.shift();try{for(;p.indexOf(",")==p.length-1;)p=p.substr(0,p.length-1);p=f(p),i.push(p)}catch(b){e.unshift(p);break}}n=n.orderBy(i);break;case"ASC":if(!i.length)throw"Must call ORDER BY before using ASC.";n=n.asc();break;case"DESC":if(!i.length)throw"Must call ORDER BY before using DESC.";n=n.desc();break;default:throw"Unintelligible query. Near: "+h}}return n;default:throw"Unintelligible query. Error near: "+e[0]}}function t(n){var e=this;e.table=n,e.values=function(t){if(void 0===jSQL.tables[n])throw"Table: "+e.table+" doesn't exist.";return jSQL.tables[n].insertRow(t),!0}}function o(n){var e=this;e.columns=n,e.from=function(n){if(void 0===jSQL.tables[n])throw"Table: "+n+" doesn't exist.";return new r(jSQL.tables[n],e.columns)}}function r(n,e){var t=this;t.table=null,t.columns=[],t.pendingColumn="",t.conditions=[],t.LIMIT=0,t.finalConditions=[],t.sortColumn=[],t.sortDirection="ASC",t.resultSet=[],t.init=function(n,e){if(t.table=n,"string"==typeof e&&(e=[e]),!Array.isArray(e))throw"Select requires a string or an array of column names.";"*"==e[0]&&(e=t.table.columns);for(var o=0;o<e.length;o++){if(t.table.columns.indexOf(e[o])<0)throw"There is no "+e[o]+" column in the "+t.table.name+" table.";t.columns.push(e[o])}},t.where=function(n){if(""!==t.pendingColumn)throw"Must add a conditional before adding another 'Where' condition.";if("string"!=typeof n)throw"Column name must be a string.";if(t.table.columns.indexOf(n)<0)throw"There is no "+n+" column in the "+t.table.name+" table.";return t.pendingColumn=n,t},t.equals=function(n){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'equals' call.";return t.conditions.push({col:t.pendingColumn,type:"=",value:n}),t.pendingColumn="",t},t.doesNotEqual=function(n){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'doesNotEqual' call.";return t.conditions.push({col:t.pendingColumn,type:"!=",value:n}),t.pendingColumn="",t},t.lessThan=function(n){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'lessThan' call.";return t.conditions.push({col:t.pendingColumn,type:"<",value:n}),t.pendingColumn="",t},t.greaterThan=function(n){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'greaterThan' call.";return t.conditions.push({col:t.pendingColumn,type:">",value:n}),t.pendingColumn="",t},t.contains=function(n){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'contains' call.";return t.conditions.push({col:t.pendingColumn,type:"%%",value:n}),t.pendingColumn="",t},t.endsWith=function(n){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'endsWith' call.";return t.conditions.push({col:t.pendingColumn,type:"%-",value:n}),t.pendingColumn="",t},t.beginsWith=function(n){if(""==t.pendingColumn)throw"Must add a 'where' clause before the 'beginsWith' call.";return t.conditions.push({col:t.pendingColumn,type:"-%",value:n}),t.pendingColumn="",t},t.and=function(n){return t.where(n)},t.or=function(n){return t.finalConditions.push(t.conditions),t.conditions=[],t.where(n)},t.limit=function(n){return t.LIMIT=parseInt(n),t},t.orderBy=function(n){Array.isArray(n)||(n=[n]);for(var e=n.length;e--;)if(t.table.columns.indexOf(n[e])<0)throw"There is no "+n[e]+" column in the "+t.table.name+" table.";return t.sortColumn=n,t},t.asc=function(){if(""==t.sortColumn)throw"Must use orderBy clause before using ASC";return t.sortDirection="ASC",t},t.desc=function(){if(""==t.sortColumn)throw"Must use orderBy clause before using DESC";return t.sortDirection="DESC",t},t.execute=function(){var n=[];t.conditions.length>0&&t.finalConditions.push(t.conditions);for(var e=0;e<t.table.data.length&&!(t.LIMIT>0&&n.length==t.LIMIT);e++)if(t.finalConditions.length<1){for(var o={},r=0;r<t.columns.length;r++)o[t.columns[r]]=t.table.data[e][r];n.push(o)}else{for(var a=!1,i=t.finalConditions.length;i--;){for(var s=t.finalConditions[i],l=!0,u=s.length;u--;){var c=s[u];switch(c.type){case">":(isNaN(parseFloat(t.table.data[e][t.table.colmap[c.col]]))||t.table.data[e][t.table.colmap[c.col]]<c.value)&&(l=!1);break;case"<":(isNaN(parseFloat(t.table.data[e][t.table.colmap[c.col]]))||t.table.data[e][t.table.colmap[c.col]]>c.value)&&(l=!1);break;case"=":t.table.data[e][t.table.colmap[c.col]]!=c.value&&(l=!1);break;case"!=":break;case"%%":t.table.data[e][t.table.colmap[c.col]].indexOf(c.value)<0&&(l=!1);break;case"%-":t.table.data[e][t.table.colmap[c.col]].indexOf(c.value)!=t.table.data[e][t.table.colmap[c.col]].length-c.value.length&&(l=!1);break;case"-%":0!=t.table.data[e][t.table.colmap[c.col]].indexOf(c.value)&&(l=!1)}if(!l)break}if(l){a=!0;break}}if(a){for(var o={},r=0;r<t.columns.length;r++)o[t.columns[r]]=t.table.data[e][r];n.push(o)}}return t.sortColumn.length>0&&(n.sort(function(n,e){return function o(r){return void 0===t.sortColumn[r]?0:n[t.sortColumn[r]]<e[t.sortColumn[r]]?-1:n[t.sortColumn[r]]>e[t.sortColumn[r]]?1:o(r+1)}(0)}),"DESC"==t.sortDirection&&n.reverse()),t.resultSet=n,t},t.fetch=function(n){if(void 0===n&&(n="ASSOC"),n=n.toUpperCase(),"ASSOC"!==n&&"ARRAY"!==n)throw"Fetch expects paramter one to be 'ASSOC', 'ARRAY', or blank";if(!t.resultSet.length)return!1;var e=t.resultSet.shift();if("ARRAY"==n){var o=[];for(var r in e)e.hasOwnProperty(r)&&o.push(e[r]);e=o}return e},t.fetchAll=function(n){if(void 0===n&&(n="ASSOC"),n=n.toUpperCase(),"ASSOC"!==n&&"ARRAY"!==n)throw"Fetch expects paramter one to be 'ASSOC', 'ARRAY', or blank";if(!t.resultSet.length)return!1;for(var e=[];t.resultSet.length>0;)e.push(t.fetch(n));return e},t.init(n,e)}function a(e,t,o){return window.jSQL.tables[e]=new n(e,t,o),!0}function i(n){return new o(n)}function s(n){return new t(n)}function l(){var n=this;n.db=null;var e=function(e,t,o,r){"function"!=typeof o&&(o=function(){}),"function"!=typeof r&&(r=function(){throw"Could not execute query: "+e});var a,i,s;Array.isArray(t[0])||(t=[t]),s=t.length;var l=function(n,e){var t,r,a=[];if(s-=1,!s){for(t=0,r=e.rows.length;r>t;t+=1){var i=e.rows.item(t).json;a.push(i)}o(a)}};n.db.transaction(function(n){for(a=0,i=t.length;i>a;a+=1)n.executeSql(e,t[a],l,r)})};n.init=function(t,o){"function"!=typeof o&&(o=function(){});var r=function(){try{for(var o=t.length;o--;)(function(t,o){e("DROP TABLE IF EXISTS "+t,[],function(){e("CREATE TABLE IF NOT EXISTS "+t+"(json TEXT)",[],function(){n.insert(t,o)})})})(t[o].name,t[o].rows)}catch(r){throw"Error creating table"}};try{var a=window.location.href.replace(/\W+/g,"");n.db=openDatabase("jSQL_"+a,"1.0","jSQL "+a,5242880)}catch(i){throw"Error opening database"}e("SELECT COUNT(*) FROM "+t[0].name,[],null,function(){r()}),o()},n.insert=function(n,t,o){"function"!=typeof o&&(o=function(){});var r,a,i=t.length,s=[];for(0===i&&o(),r=0,a=t.length;a>r;r+=1)s[r]=[JSON.stringify(t[r])];e("INSERT INTO "+n+" (json) VALUES (?);",s,o)},n["delete"]=function(n,t){"function"!=typeof t&&(t=function(){}),e("DELETE FROM "+n,[],t)},n.select=function(n,t){e("SELECT json FROM "+n,[],function(n){for(var e=[],o=n.length;o--;)e.push(JSON.parse(n[o]));t(e)})}}function u(){var n=this;n.db=null;var e,t,o;n.init=function(r,a){"function"!=typeof a&&(a=function(){});try{e=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,t=window.hasOwnProperty("webkitIndexedDB")?window.webkitIDBTransaction:window.IDBTransaction,o=window.hasOwnProperty("webkitIndexedDB")?window.webkitIDBKeyRange:window.IDBKeyRange}catch(i){throw"indexedDB is not supported in this browser"}if(!e)throw"indexedDB is not supported in this browser";var s=1,l=window.location.href.replace(/\W+/g,""),u=e.open("jSQL_"+l,s),c=function(){for(var e=r.length;e--;)n.db.objectStoreNames.contains(r[e].name)&&n.db.deleteObjectStore(r[e].name),n.db.createObjectStore(r[e].name,{keyPath:"_id",autoIncrement:!0});var t=0,o=!1,a=setInterval(function(){if(!o){o=!0;try{for(var e=r.length;e--;){var i=r[e].name,s=void 0==r[e].rows?[]:r[e].rows;n.insert(i,s)}clearInterval(a)}catch(l){if(t>1e3)throw clearInterval(a),"Could not add data after 10 seconds.";o=!1}}},10)};u.onsuccess=function(e){var t;n.db=e.target.result,s=String(s),n.db.setVersion&&s!==n.db.version?(t=n.db.setVersion(s),t.onfailure=function(){throw"Error updating datastore version"},t.onsuccess=function(n){c(),t.result.oncomplete=function(){a()}}):a()},u.onupgradeneeded=function(e){n.db=e.target.result,c()},u.onerror=function(n){throw"Could not connect to the indexedDB datastore."}},n.insert=function(e,o,r){"function"!=typeof r&&(r=function(){});var a,i,s,l=n.db.transaction([e],t.READ_WRITE||"readwrite"),u=o.length,c=function(){u-=1,0===u&&r(u)};l.onerror=function(){throw"Could not initiate a transaction"},a=l.objectStore(e);for(i in o)o.hasOwnProperty(i)&&(s=a.add(o[i]),s.onsuccess=c,s.onerror=function(){throw"Could not initiate a request"})},n["delete"]=function(e,o){"function"!=typeof o&&(o=function(){});var r,a,i=n.db.transaction([e],t.READ_WRITE||"readwrite");i.onerror=function(){throw"Could not initiate a transaction"},r=i.objectStore(e),a=r.clear(),a.onerror=function(){throw"Could not initiate a request"},a.onsuccess=o},n.select=function(e,o){"function"!=typeof o&&(o=function(){});var r,a,i=n.db.transaction([e],t.READ_ONLY||"readonly"),s=[];i.onerror=function(){throw"Could not initiate a transaction"},r=i.objectStore(e),a=r.openCursor(),a.onerror=function(){throw"Could not initiate a request"};var l=!1;a.onsuccess=function(n){if(!l){var e=n.target.result;return e?(s.push(e.value),void e["continue"]()):(l=!0,void o(s))}}}}var c=new function(){var n=this;n.api=null,n.error=!1,n.persist=function(e){if("function"==typeof e&&(e=function(){}),n.error!==!1)throw n.error;for(var t in jSQL.tables)if(jSQL.tables.hasOwnProperty(t)){for(var o=jSQL.select("*").from(t).execute().fetchAll(),r=[],a=o.length;a--;){var i=o[a];for(var s in i)i.hasOwnProperty(s)&&"function"==typeof i[s]&&(i[s]="#jSQLFunct#"+i[s].toString());r.push({table:t,data:JSON.stringify(i)})}n.api["delete"]("jSQL_data_schema",function(){n.api.insert("jSQL_data_schema",r,e)})}},n.load=function(e){"function"!=typeof e&&(e=function(){}),function t(o){try{n.api.select("jSQL_data_schema",function(n){if(jSQL.tables={},0===n.length)return e();for(var t=n.length;t--;){var o=n[t].table,r=JSON.parse(n[t].data);if(void 0===jSQL.tables[o]){var a=[];for(var i in r)r.hasOwnProperty(i)&&a.push(i);jSQL.createTable(o,a,[])}for(var i in r)r.hasOwnProperty(i)&&"string"==typeof r[i]&&0===r[i].indexOf("#jSQLFunct#")&&(r[i]=exec(r[i].substr(11)));jSQL.tables[o].insertRow(r)}return e()})}catch(r){if(o>500)return e();setTimeout(function(){t(o+1)},10)}}(0)},function(){try{n.api=new u,n.api.init([{name:"jSQL_data_schema",rows:[]}])}catch(e){try{n.api=new l,n.api.init([{name:"jSQL_data_schema",rows:[]}])}catch(t){n.error="Browser doesn't support Web SQL or IndexedDB"}}}()};return{tables:{},query:e,createTable:a,select:i,insertInto:s,persist:c.persist,load:c.load}}();